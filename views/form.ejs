    <% if (typeof notif !== 'undefined' && notif) { %>
      <div class="notif"><%= notif %></div>
    <% } %>
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= contact.id ? '√âditer' : 'Ajouter' %> un contact</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1><%= contact.id ? '√âditer' : 'Ajouter' %> un contact</h1>
    <form action="<%= action %>" method="<%= method %>">
      <label>Nom</label>
      <input type="text" name="nom" id="nom" value="<%= contact.nom || '' %>" required>
      <label>Pr√©nom</label>
      <input type="text" name="prenom" id="prenom" value="<%= contact.prenom || '' %>" required>
      <label>Num√©ro de t√©l√©phone</label>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="text" name="num_tel" id="num_tel" value="<%= contact.num_tel || '' %>" required>
        <button type="button" id="lookupBtn" class="btn" title="Rechercher infos">üîç</button>
        <span id="lookupStatus" style="margin-left:4px;"></span>
      </div>
      <label>Adresse</label>
      <input type="text" name="adresse" id="adresse" autocomplete="off" value="<%= contact.adresse || '' %>" required>
      <ul id="suggestions" class="suggestions-list"></ul>
      <label>Statut de contact</label>
      <select name="contact_statut" required>
        <% contactStatus.forEach(s => { %>
          <option value="<%= s %>" <%= contact.contact_statut === s ? 'selected' : '' %>><%= s %></option>
        <% }) %>
      </select>
      <label>Statut de r√©ponse</label>
      <select name="reponse_statut" required>
        <% responseStatus.forEach(s => { %>
          <option value="<%= s %>" <%= contact.reponse_statut === s ? 'selected' : '' %>><%= s %></option>
        <% }) %>
      </select>
      <label>Commentaire</label>
      <textarea name="commentaire" rows="3" placeholder="Commentaire..."><%= contact.commentaire || '' %></textarea>
      <button type="submit" class="btn">Valider</button>
      <a href="/" class="btn">Annuler</a>
    </form>
    <script>
      const lookupBtn = document.getElementById('lookupBtn');
      const lookupStatus = document.getElementById('lookupStatus');
      lookupBtn.addEventListener('click', async function() {
        const num_tel = document.getElementById('num_tel').value.trim();
        if (!num_tel) return alert('Veuillez entrer un num√©ro de t√©l√©phone.');
        this.disabled = true;
        this.textContent = '...';
        lookupStatus.innerHTML = '<span style="display:inline-block;width:18px;height:18px;"><svg viewBox="0 0 50 50" style="width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="25" r="20" stroke="#888" stroke-width="5" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.8s" repeatCount="indefinite"/></circle></svg></span>';
        try {
          const res = await fetch(`/api/lookup?num_tel=${encodeURIComponent(num_tel)}`);
          console.log('[client] Status:', res.status);
          const text = await res.text();
          console.log('[client] R√©ponse brute:', text);
          let data;
          try {
            data = JSON.parse(text);
          } catch (err) {
            console.error('[client] Erreur de parsing JSON:', err);
            lookupStatus.innerHTML = '<span style="color:red;font-size:18px;">‚ùå</span>';
            alert('R√©ponse serveur non valide.');
            this.disabled = false;
            this.textContent = 'üîç';
            return;
          }
          if (data.error) throw new Error(data.error);
          console.log('[client] Data √† remplir:', data);
          let found = false;
          try {
            document.getElementById('nom').value = data.nom || '';
            if (data.nom) found = true;
          } catch(e) {
            console.error('[client] Erreur champ nom:', e);
          }
          try {
            document.getElementById('prenom').value = data.prenom || '';
            if (data.prenom) found = true;
          } catch(e) {
            console.error('[client] Erreur champ prenom:', e);
          }
          try {
            document.getElementById('adresse').value = data.adresse || '';
            if (data.adresse) found = true;
          } catch(e) {
            console.error('[client] Erreur champ adresse:', e);
          }
          lookupStatus.innerHTML = found ? '<span style="color:green;font-size:18px;">‚úîÔ∏è</span>' : '<span style="color:red;font-size:18px;">‚ùå</span>';
        } catch(e) {
          console.error('[client] Erreur fetch:', e);
          lookupStatus.innerHTML = '<span style="color:red;font-size:18px;">‚ùå</span>';
          alert('Aucune information trouv√©e ou erreur r√©seau.');
        }
        this.disabled = false;
        this.textContent = 'üîç';
      });
    </script>
  </div>
  <script>
    const adresseInput = document.getElementById('adresse');
    const suggestionsList = document.getElementById('suggestions');
    let timer;
    adresseInput.addEventListener('input', function() {
      clearTimeout(timer);
      const query = adresseInput.value.trim();
      if (query.length < 3) {
        suggestionsList.innerHTML = '';
        return;
      }
      timer = setTimeout(() => {
        fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            suggestionsList.innerHTML = '';
            if (data.features && data.features.length) {
              data.features.slice(0,5).forEach(f => {
                const li = document.createElement('li');
                li.textContent = f.properties.label;
                li.className = 'suggestion-item';
                li.onclick = () => {
                  adresseInput.value = f.properties.label;
                  suggestionsList.innerHTML = '';
                };
                suggestionsList.appendChild(li);
              });
            }
          });
      }, 300);
    });
    document.addEventListener('click', function(e) {
      if (!adresseInput.contains(e.target) && !suggestionsList.contains(e.target)) {
        suggestionsList.innerHTML = '';
      }
    });
  </script>
</body>
</html>
